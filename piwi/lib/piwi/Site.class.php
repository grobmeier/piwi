<?/** * Renders the requested page and creates the navigation based on 'site.xml'. */class Site {	/** Name of the folder where the content is placed. */	private $contentPath = null;		/** The name of the file containing the site information. */	private $siteFilename;		/** The site definition as DOMDocument. */    private $siteXml;                /** The DOMXPath of the siteXml. */    private $domXPath = null;    	/** The id of the requested page. */	private $pageId = null;		/** The template of the requested page. */	private $template = "default.php";		/** The content of the requested page as DOMDocument. */	private $content;           /**     * Constructor.     * @param string $contentPath Name of the folder where the content is placed.     * @param string $siteFilename The name of the file containing the site information.     * @param string $pageId The id of the requested page.     */    public function __construct($contentPath, $siteFilename = 'site.xml', $pageId) {
    	$this->contentPath = $contentPath;    	$this->siteFilename = $siteFilename;    	$this->pageId = $pageId;    }        /**     * Reads the xml of the requested page.     */    public function readContent() {    	if ($this->pageId == null) {			throw new PiwiException(				"The requested page has not been specified.", 				PiwiException :: ERR_ILLEGAL_STATE);    	}    	    	if ($this->siteXml == null) {    		$this->loadSite();    	}    	// Lookup pageId        $domXPath = new DOMXPath($this->siteXml);        $result = $domXPath->query("//page[@id='".$this->pageId."']");        if($result->length > 0) {        	// Load content        	$filePath = $this->contentPath . '/' .$result->item(0)->getAttribute("href");        	        	if (!file_exists($filePath)) {				throw new PiwiException(					"Could not find the the requested page (Path: '" . $filePath . "').", 					PiwiException :: ERR_404);    		}        	    	    		$this->content = new DOMDocument;			$this->content->load($filePath);						// Set template if specified			$template = $result->item(0)->getAttribute("template");            if ($template != "") {            	$this->template = $template;            }        } else {            throw new PiwiException(				"Could not find the requested page (Page: '" . $this->pageId . "').", 				PiwiException :: ERR_404);        }    }        /**     * Sets the content of the page.     * @param string $content The content as xml.     */    public function setContent($content) {    	$this->content = new DOMDocument;    	$this->content->loadXML($content);    }        /** Transforms the page using the specified serializer */    public function transform() {    	if ($this->content == null) {    		throw new PiwiException(				"The page has not been loaded yet. Invoke method 'readContent' or 'setContent' on '" . __CLASS__ . "' first.", 				PiwiException :: ERR_ILLEGAL_STATE);    	}    	    	$serializer = new HTMLSerializer();    	    	    	return $serializer->serialize($this->content);    }        /**     * Generates the Navigation.     * @return string The navigation as HTML.     */    public function generateNavigation() {    	if ($this->siteXml == null) {	    	try {	    		$this->loadSite();	    	} catch( PiwiException $exception ) {				// If this exception occurs the 'site.xml' can not be found.				return "Navigation could not be build. Could not find the site definition file (Path: '" . $this->siteXmlPath . "').";			}    		    	}		// Determinate all nodes that lead to the current page    	$openpath = array();    	        $this->domXPath = new DOMXPath($this->siteXml);        $domNodeList = $this->domXPath->query("//page[@id='".$this->pageId."']");        $index = 0;        foreach ($domNodeList as $element) {            while($element->nodeName != "site") {                    $openpath[$index++] = $element->getAttribute("id");                    $element = $element->parentNode;            }        }                // Build array containing all sites and subsites        $xpath = "/site/page";        $nodelist = $this->domXPath->query($xpath);        $result = $this->generateSubnavigation(array(), $nodelist, $xpath, $openpath);                // Initialize the Class building the menu        $navigation = new SimpleTextNavigation();                return $navigation->generate($result);    }        /**     * Generates the submenus of the given nodes.     * @param array $result Array of NavigationElements.     * @param DOMNodeList $nodelist List of nodes in the current layer.     * @param string $xpath The xpathquerystring of the current layer.     * @param array $openpath The ids nodes that lead to the current pageId.     * @return array description     */    private function generateSubnavigation($result, DOMNodeList  $nodelist, $xpath, $openpath) {        $index = 0;        foreach ($nodelist as $element) {        	$id = $element->getAttribute("id");        	        	$navigationElement = new NavigationElement($id, $element->getAttribute("label"));           	$navigationElement->setSelected($id == $this->pageId);           	$navigationElement->setOpen(in_array($id, $openpath));						$result[$index] = $navigationElement;	        if($element->hasChildNodes()) {            	$children = $this->domXPath->query($xpath."[@id='".$id."']/*");               	$result[$index]->setChildren($this->generateSubnavigation(array(), $children, $xpath . '/page', $openpath));            }    		$index++;      	}      	return $result;    }        /**     * Returns the template of the requested page.     * @return string The template of the requested page.     */    public function getTemplate() {    	return $this->template;    }        /**     * Loads the 'site.xml'.     */    private function loadSite() {    	$path = $this->contentPath . '/' . $this->siteFilename;       	if (!file_exists($path)) {			throw new PiwiException(				"Could not find the site definition file (Path: '" . $path . "').", 				PiwiException :: ERR_NO_XML_DEFINITION);    	}    	    	// Load 'site.xml'    	$this->siteXml = new DOMDocument;		$this->siteXml->load($path);    }}?>